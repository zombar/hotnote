name: Build and Deploy

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read

env:
  REGISTRY: registry.digitalocean.com
  IMAGE_NAME: hotnote/hotnote

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      version: ${{ steps.meta.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DigitalOcean Container Registry
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            echo "${{ secrets.DIGITALOCEAN_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ secrets.DIGITALOCEAN_TOKEN }} --password-stdin

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha
            type=raw,value=latest

      - name: Build and push Docker image
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 20
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            docker buildx build \
              --push \
              --platform linux/amd64 \
              --cache-from type=gha \
              --cache-to type=gha,mode=max \
              $(echo "${{ steps.meta.outputs.tags }}" | sed 's/^/--tag /; s/\n/ --tag /g' | tr '\n' ' ') \
              $(echo "${{ steps.meta.outputs.labels }}" | sed 's/^/--label /; s/\n/ --label /g' | tr '\n' ' ') \
              .

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Pulumi dependencies
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 15
          command: cd infra && npm install

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Deploy with Pulumi
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            cd infra
            pulumi stack select hotnote --create
            pulumi up --yes --skip-preview
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          DIGITALOCEAN_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.version }}
          GITHUB_REPOSITORY: ${{ github.repository }}
